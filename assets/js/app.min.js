/*
	
	Project Name 			:	Masonry Timeline;
	Project Description 	:	A masonry timeline with ajax document onload, onScroll append data;
	Author Name 			:	Saifur Rahman (Hasan);
	Author Mobile Number 	:	+8801727213319;
	Author Email 			:	saifur.dohs@gmail.com

*/

$(function(){

	// Preventing Default Behaviour For Hashed Link
	$('a[href="#"]').click(function(event){ event.preventDefault(); }); 

	// Initialize Bootstrap Tooltip
	$('[data-toggle="tooltip"]').tooltip({'container' : 'body', 'html' : true});

	function init_tooltip(){
		$('[data-toggle="tooltip"]').tooltip({'container' : 'body', 'html' : true});
	}

	// Masonry Timeline Grid Initialize
	var $grid = $('#timeline-grid');

	// Alert Error
	var alert_error;

	var is_ajax_running = true;

	// Sending Ajax Request
	$.ajax({
		url: 'get_posts.php', type: 'GET', dataType: 'html'
	})
	.done(function(data) {
		
		$grid.append(data);
		
		$grid.masonry({
			itemSelector: '.timeline-grid-item',
			columnWidth: '.grid-item-width-1-2',
			percentPosition: true,
			gutter: 15
		})
		.masonry('appended', data)
		.masonry();
		
		init_tooltip();

		return is_ajax_running = false;

	})
	.fail(function(data) {

		return is_ajax_running = true;
		
		alert_error = `
			<div class="alert alert-danger">
				<button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>
				<strong>Error!</strong> <br>
				${data.responseText}
			</div>
		`;
		(data.responseText.length >= 1) ? $('#alert-error').html(`${alert_error}`) : '' ;

	});
	

	$(window).scroll(function(){
		
		var recent_scrolled_amount 	=	$(window).scrollTop();
		var last_scrollable_abount	=	$(document).height() - $(window).height();

		if(recent_scrolled_amount >= last_scrollable_abount){

			if(!is_ajax_running){
				
				is_ajax_running = true;

				$.ajax({
					url: 'get_posts.php', type: 'GET', dataType: 'html'
				})
				.done(function(data) {

					$grid.append(data);
		
					$grid.masonry({
						itemSelector: '.timeline-grid-item',
						columnWidth: '.grid-item-width-1-2',
						percentPosition: true,
						gutter: 15
					})
					.masonry('appended', data)
					.masonry('reloadItems')
					.masonry();

					init_tooltip();

					return is_ajax_running = false;
				
				})
				.fail(function(data) {

					return is_ajax_running = true;

					alert_error = `
						<div class="alert alert-danger">
							<button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>
							<strong>Error!</strong> <br>
							${data.responseText}
						</div>
					`;
					(data.responseText.length >= 1) ? $('#alert-error').html(`${alert_error}`) : '' ;

				});
				

			}else{
				alert('Please wait untill before post append');
			}

		}

	});

});